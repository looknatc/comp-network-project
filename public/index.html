<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
			integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
			crossorigin="anonymous"
		/>
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
		<link rel="stylesheet" href="css/style.css" />
		<title>Chatshire App</title>
		<script src="https://code.jquery.com/jquery-3.6.4.js" integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E=" crossorigin="anonymous"></script>
		<!-- <script src=”https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js”></script> -->
		<script type="test/javascript" src="utils/helper.js"></script>
	</head>
	<body>
		<div class="join-container">
			<header class="join-header">
				<h1><i class="fas fa-cat"></i> Chatshire</h1>
				<div class="leave-container">
				<!-- <h3 id="myUsername"></h3><button type="button" id="exit">exit</button> -->
				<h3 id="myUsername"></h3><span class="material-symbols-outlined" id="exit">logout</span>
				</div>
			</header>
			<main class="join-main">
				<div class="index-sidebar">
					<!-- <h3><i class="fas fa-comments"></i> Room Name:</h3>
					<h2 id="room-name"></h2> -->
					<h3><i class="fas fa-users"></i>Users</h3>
					<ul id="users"></ul>
				</div>
				<form id="chat-form">
					
					<div class="form-control">
						<label for="room">Room</label>
						<select name="room" id="room">

						</select>
					</div>
					<div class="form-control" id="newRoom">
						<label for="create-room">Create-Room</label>
						<input
							type="text"
							name="newRoomName"
							id="newRoomName"
							placeholder="Enter Room Name..."
						/>
						<span class="material-symbols-outlined" id="submitNameBtn">
							add_circle
							</span>
						<!-- <button type="button" id="submitNameBtn">New Room</button> -->
					</div>
					<button type="submit" class="btn">Join Chat</button>
				</form>

			</main>
		</div>
	</body>
</html>
<script src="/socket.io/socket.io.js"></script>
<script>
// function Remove_options(){
// 	$('#room').empty()
// }
var username = new URLSearchParams(window.location.search).get('username');
// var hasUnread = [];
var hasUnread = new Set();

function addUserToList(name) {
  // Create a new list item with the user's name and a DM button
	console.log("hasUnread",hasUnread);
	var liStr = `<li id="${name}">`
	if(hasUnread.has(name)){
		liStr = `<li id="${name}" class="unRead">`
	}
	var listItem = $(liStr).append(
	$('<div class="dot">'),
    $('<span>').text(name),
	$('<span>').text("chat").addClass("material-symbols-outlined dm-btn")
	)
	$('#users').append(listItem);
//   if(hasUnread.has(name)){
// 	var listItem = $(`<li id="${name}" class="unRead">`).append(
// 	$('<div class="dot">'),
//     $('<span>').text(name),
// 	$('<span>').text("chat").addClass("material-symbols-outlined dm-btn")
//     // $('<button>').text('DM').addClass('dm-btn')
//   );

//   }else{
// 	var listItem = $(`<li id="${name}">`).append(
// 	$('<div class="dot">'),
//     $('<span>').text(name),
// 	$('<span>').text("chat").addClass("material-symbols-outlined dm-btn")
//     // $('<button>').text('DM').addClass('dm-btn')
//   );
//   }
  
  
//   // Add the list item to the users list
//   $('#users').append(listItem);
}
function outputRoomList(rooms){
	$('#room').empty();
	var roomSelect = document.getElementById("room");
	for(r in rooms){
		var roomOption = document.createElement("option");
		// console.log(r)
		roomOption.text = rooms[r];
		roomOption.value = rooms[r];
		roomSelect.add(roomOption);
	}
}
function outputAllUsers(users){
	$('#users').empty();
	for( i in users){
		// console.log(users[i],users[i].username)
		if(users[i].username != username){
			addUserToList(users[i].username);
		}
		
	}

}
function showOnlineUsers(users){
	console.log("showOnlineUsers",users)
	// remvoe all clase first 
	var li = $("#users > li")
	for( i =0;i< li.length;i++){
		$(li[i]).removeClass("online")
	}
	// add clas for online
	for( i in users){
		var user = users[i]
		$(`#${user.username}`).addClass("online")
	}

	//sort by online 
	var items = $("#users > li").get();
	items.sort((a, b) => {
	const aTop = $(a).hasClass('online');
	const bTop = $(b).hasClass('online');
	
	if (aTop && !bTop) {
		return -1;
	} else if (!aTop && bTop) {
		return 1;
	} else {
		return 0;
	}
	});
	$('#users').empty();
	$(items).appendTo('#users');

}
function showAlertDM(message){
	$(`#${message.from}`).addClass("unRead")
}

function showUnread(result){
	var user = result.username
	var rooms = result.rooms
	for(i in rooms){
		var room = rooms[i];
		if ((room.status ==1) &&/^([^?]+\?){3}[^?]+$/.test(room.sender)) {
			const arr = (room.sender).split("?");
			console.log("server: room name split" ,arr); // ["xxx", "yyyyy", "xxxxx", "yyyyyy"]
			var sender = arr[1]
			if(user == arr[1]){
				sender = arr[3]
			}
			$(`#${sender}`).addClass("unRead")
			hasUnread.add(sender)
		}
	}

}

$(function() {
    console.log( "ready!" );
	const socket = io();

	// re join room because change of page will auto disconnect 
	socket.emit('userJoin', {username});
	
	$("#myUsername").html(username);

	$("#submitNameBtn").click(function(){
		var roomName = $("#newRoomName").val()
		// console.log(roomName)
		if(roomName != ""){
			socket.emit('newRoom', {roomName});
		}
		$("#newRoomName").val("");
		
	});

	$("#exit").click(function(){
		const leaveRoom = confirm('Are you sure you want to exit');
		if (leaveRoom) {
			// window.location = '../index.html';
			window.location.href = '/login.html';
			socket.disconnect();
		} else {
  }
		
	});

	$("#submitUserName").click(function(){
		var username = $("#username").val()
		socket.emit('userJoin', {username});
	});

	socket.emit("allUser",{});
	socket.on("allUserResponse",(users) =>{
		console.log("allUserResponse",users);
		outputAllUsers(users);
	});
	// socket.on("userJoin",(users) =>{
	// 	console.log("userJoin",users);
	// 	outputAllUsers(users);
	// });

	// socket.emit('NaoNao', {a:"b" });


	socket.emit('roomList', {});
	socket.on("roomListResponse",(rooms)=>{
		console.log(rooms);
		outputRoomList(rooms);
	});

	socket.on("directMessage",(x)=>{
		console.log("directMessage",x);
	});
	
	socket.on('roomUsers', ({ room, users }) => {
		outputRoomName(room);
		outputUsers(users);
	});

	socket.on('allOnlineUserResponse', ({allOnlineUser,readStatus}) => {
		// outputRoomName(room);
		// outputUsers(users);
		showOnlineUsers(allOnlineUser)
		console.log("allOnlineUserResponse",allOnlineUser);
		// showUnread

	});
	socket.emit("readStatus",{username});
	socket.on("readStatus",(result)=>{
		console.log("index.html readStatus",result)
		showUnread(result)
	});
	socket.on('alertDM', (message) => {
        console.log("index.html message",message,message.from);
		showAlertDM(message);
		// hasUnread.push(message.from)
		hasUnread.add(message.from)
		console.log("hasUnread",hasUnread)
        // outputMessage2(message);

        // // Scroll down
        // chatMessages.scrollTop = chatMessages.scrollHeight;
    });





	//when submit form go to chat in chosen room 
	$("#chat-form").submit(function(event){
		event.preventDefault(); // prevent the default form submission

		const urlParams = new URLSearchParams(window.location.search);
		const username = urlParams.get('username');
		var selectedRoom = $("#room option:selected").val();
		
		window.location.href = '/chat.html?username=' + username + "&room=" + selectedRoom;
		 
	});


});
	$(document).on('click', '.dm-btn', function() {
	var name = $(this).prev().text();
	// hasUnread = hasUnread.filter(n => n !==name)
	hasUnread.delete(name);
	var from = username;
	console.log(name);
	window.location = '../dm.html?name=' + encodeURIComponent(name)+"&from="+encodeURIComponent(from);
	
	});

</script>
